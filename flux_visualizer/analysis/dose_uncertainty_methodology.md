# Dose Calculation Uncertainty Methodology

## Overview

The STRATOS dose calculator implements uncertainty estimation for radiation dose calculations along orbital trajectories. The system can use either **actual flux uncertainties from VTK data** or **synthetic uncertainty estimates** as fallback. Error bands in the plots represent 1-sigma confidence intervals.

## Data-Driven vs Synthetic Uncertainties

### Data-Driven Uncertainties (Preferred)
When VTS files contain uncertainty arrays (generated by `generate_flux_with_uncertainty.py`), the dose calculator uses actual measurement uncertainties:
- Flux uncertainties are sampled at each orbital position
- Uncertainties are properly propagated through dose conversion
- Cumulative dose uncertainties account for error accumulation through integration
- Based on physics-motivated uncertainty models for each L-shell region

### Synthetic Uncertainties (Fallback)
When no uncertainty data is available, the system estimates uncertainties using five components:

## Instantaneous Dose Rate Uncertainties

For synthetic estimates, dose rate uncertainties are constant in time. The model combines five components using root-sum-of-squares:

### 1. Poisson Statistical Uncertainty
- Relative uncertainty: 1/√N_eff where N_eff is effective particle count
- Typical: 1-10% for moderate fluxes

### 2. Flux Field Interpolation Uncertainty  
- Relative uncertainty: 10%
- From VTK spatial interpolation between grid points

### 3. Cross-Sectional Area Uncertainty
- Relative uncertainty: 2%
- From geometric measurement precision

### 4. Energy Conversion Factor Uncertainty
- Relative uncertainty: 5%
- From particle energy spectrum and stopping power uncertainties

### 5. Baseline Uncertainty
- Absolute uncertainty: 1% of maximum dose rate
- Represents measurement noise floor

## Total Instantaneous Uncertainty

```
σ_rate = √(σ_poisson² + σ_interp² + σ_area² + σ_energy² + σ_baseline²)
```

This uncertainty remains constant throughout the measurement period.

## Cumulative Dose Uncertainty Propagation

Cumulative dose uncertainties grow with time due to error accumulation through integration.

### Statistical Error Propagation

Integration of uncertain measurements:
```
σ²_statistical(t) = Σᵢ [σ_rate(tᵢ) × Δtᵢ]²
```
Grows as √N where N is the number of measurement intervals.

### Systematic Drift

Calibration drift and model uncertainties:
```
σ_systematic(t) = cumulative_dose(t) × 0.002 × t_hours
```
0.2% per hour drift from calibration and environmental changes.

### Correlation Factor

Accounts for persistent systematic biases:
```
correlation_factor = 1 + 0.001 × √t_hours
```

### Total Cumulative Uncertainty

```
σ_cumulative = √[(σ_statistical × correlation_factor)² + σ_systematic²]
```

## Typical Uncertainty Magnitudes

### Data-Driven Uncertainties (from VTS files)
| L-Shell Region | Dose Rate Uncertainty | Cumulative Dose (1h) | Cumulative Dose (24h) |
|----------------|----------------------|---------------------|----------------------|
| Inner Belt (L=1.2-2.8) | 15% | 15% | 18-25% |
| Slot Region (L=2.5-3.2) | 30% | 30% | 35-50% |
| Outer Belt (L=3.0-8.0) | 20% | 20% | 25-40% |
| Plasma Sheet (L>6.0) | 40% | 40% | 50-70% |

### Synthetic Uncertainties (fallback)
| Flux Region | Dose Rate | Cumulative Dose (1h) | Cumulative Dose (24h) |
|-------------|-----------|---------------------|----------------------|
| Van Allen Belt Peak | 8-15% | 10-20% | 20-40% |
| Moderate Flux | 12-20% | 15-25% | 25-50% |
| Low Flux | 20-50% | 25-60% | 40-80% |

## Implementation

Error bands are displayed using `matplotlib.fill_between()` to show continuous uncertainty regions.

### Key Methods
- `FluxAnalyzer.calculate_dose_time_series()`: Computes dose with actual flux uncertainties
- `FluxAnalyzer.analyze_flux_at_point()`: Samples flux and uncertainty at orbital positions  
- `VTKDataLoader.get_uncertainty_arrays()`: Retrieves uncertainty data from VTS files
- `DoseWindow._calculate_dose_rate_errors()`: Fallback synthetic uncertainty estimates (when no data available)

### Data Flow
1. VTS files loaded with uncertainty arrays (`electron_flux_uncertainty`, `electron_flux_relative_uncertainty`)
2. Flux sampled at orbital positions with uncertainties
3. Dose conversion applies uncertainties: `dose_uncertainty = flux_uncertainty × conversion_factor`
4. Cumulative uncertainties propagated through integration: `σ²_cum = σ²_cum_prev + (σ_rate × Δt)²`

Console output indicates which uncertainty method is used:
- "Using actual flux uncertainties from data (mean relative: X.X%)"
- "Using synthetic uncertainty estimates (no flux uncertainty data)"